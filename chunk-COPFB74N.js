/* 
MIT License

Copyright (c) 2020 Steve Xu

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
import{a as rt,b as st,d as ht}from"./chunk-2EW72QMQ.js";import{B as tt,D as q,L as et,N as k,S as W,T as u,U as it,W as nt,Y as P,Z as A,_ as O,aa as ot,b as N,h as U,j as J,k as p,l as L,ua as _,v as Q,xa as v}from"./chunk-6ACQG57Y.js";function Y(r){return r?typeof Intl>"u"||typeof Intl.Segmenter!="function"?[...r]:[...new Intl.Segmenter([],{granularity:"word"}).segment(r)].map(i=>i.segment):[]}var j=new Map;function mt(r,t){let e=`${t}__${r.font}`;if(j.has(e))return j.get(e);let i=r.measureText(t),{actualBoundingBoxAscent:n,actualBoundingBoxDescent:s}=i,o=n+s,l=i.width,a=Math.ceil(l/W()),h=Math.ceil(o/W()),c={width:a,height:h};return j.set(e,c),c}function R(r,t,e,i,n){r.fillRect(u(t),u(e),u(i),u(n))}function B(r,t,e,i,n){r.strokeRect(u(t),u(e),u(i),u(n))}function K(r,t,e,i,n){r.clearRect(u(t),u(e),u(i),u(n))}function G(r,t,e,i){r.fillText(t,u(e),u(i))}function I(r,t){if(t.length!==0){r.beginPath();for(let e=0;e<t.length;e+=2){let i=t[e],n=t[e+1];r.moveTo(u(i[0]),u(i[1])),r.lineTo(u(n[0]),u(n[1]))}r.stroke()}}function V(r,t,e,i){r.beginPath(),r.moveTo(u(t[0]),u(t[1])),r.lineTo(u(e[0]),u(e[1])),r.lineTo(u(i[0]),u(i[1])),r.fill()}function lt(r,t,e){let i=r.slice(),[n,s]=r,o=p*2,l=e?o:0;return t==="bottom"?i.push([n[0]+l,n[1]-o],[s[0]-l,s[1]-o]):t==="top"?i.push([n[0]+l,n[1]+o],[s[0]-l,s[1]+o]):t==="left"?i.push([n[0]+o,n[1]+l],[s[0]+o,s[1]-l]):t==="right"&&i.push([n[0]-o,n[1]+l],[s[0]-o,s[1]-l]),i}function pt(r,t,e){return e?t?r.split(N):Y(r.replaceAll(N,"")):Y(r)}function at(r,t,e,i,n){r.setLineDash([u(8),u(6)]);let s=p;B(r,t+s,e+s,i-s*2,n-s*2),r.setLineDash([])}function Ct(r){let t=[];return r==="hair"?t=[p,p]:r==="dotted"||r==="mediumDashed"?t=[p*2,p*2]:r==="dashed"?t=[p*4,p*4]:r==="dashDot"||r==="mediumDashDot"?t=[p*4,p*4,p*8,p*4]:(r==="dashDotDot"||r==="mediumDashDotDot")&&(t=[p*4,p*4,p*8,p*4,p*4,p*4]),t}function H(r,t,e,i,n){if(!e)return;let{top:s,left:o,width:l,height:a}=t,h=[];i==="top"?h=[[o,s],[o+l,s]]:i==="bottom"?h=[[o,s+a],[o+l,s+a]]:i==="left"?h=[[o,s],[o,s+a]]:i==="right"&&(h=[[o+l,s],[o+l,s+a]]);let{type:c,color:d}=e;r.lineWidth=L[c],r.strokeStyle=d||v("black",n);let f=Ct(c);c==="double"&&(h=lt(h,i,!0)),f.length>0&&r.setLineDash(f.map(g=>u(g))),I(r,h),f.length>0&&r.setLineDash([])}function ct(r,t,e,i,n,s){let o={height:0,width:0};if(e===""&&Q(i))return o;let l=i?.numberFormat||U,a=l===U&&typeof e=="number",h=rt(e,l),c=i?.fontSize?i.fontSize:12,d=k(i?.isItalic?"italic":"normal",i?.isBold?"bold":"500",u(c),i?.fontFamily);i?.fillColor&&(r.fillStyle=i?.fillColor,R(r,t.left,t.top,t.width,t.height));let f=i?.fontColor||v("contentColor",s);J.has(h)&&(f=v("errorFormulaColor",s)),r.font=d,r.fillStyle=f;let g=i?{...i}:{},m=g?.horizontalAlign;g?.horizontalAlign===void 0&&a&&(m=2),g.horizontalAlign=m;let x=(!g?.isWrapText&&st(l)?[h]:pt(h,i?.isWrapText,n)).map(z=>{let S=mt(r,z);return{str:z,width:S.width,height:S.height===0?c:S.height}}),{width:y,height:T,resultList:b}=wt(x,t,g,et(!!n,h));if(y>0&&T>0){let z=Math.ceil(c*(_.lineHeight-1)/2),S=[];for(let D of b){if(G(r,D.text,D.x,D.y),g?.underline){r.strokeStyle=f;let M=D.y+D.height+z/2,$=[[D.x,M],[D.x+D.width,M]];g?.underline===2?S=S.concat(lt($,"bottom",!1)):S=S.concat($)}if(g?.isStrike){r.strokeStyle=f;let M=D.y+D.height/2+z/2;S=S.concat([[D.x,M],[D.x+D.width,M]])}}I(r,S)}return o.height=Math.ceil(T),o.width=Math.ceil(y),o}function wt(r,t,e,i){let n=e?.fontSize?e.fontSize:12,s=Math.ceil(n*(_.lineHeight-1)/2),o=e?.verticalAlign??1,{left:l,top:a,height:h}=t,c=Math.max(t.width,...r.map(m=>m.width)),d=[],f=0,g=0;if(e?.isWrapText&&i){let m=0;for(let w=0;w<r.length;w++){let C=r[w];f=Math.max(f,C.width);let x=C.height+s*2;g+=x,d.push({text:C.str,x:0,y:m,width:C.width,height:C.height}),m+=x}}else if(e?.isWrapText){let m=0;for(let w=0;w<r.length;){let C=c,x="",y=0,T=0;for(;w<r.length;){let b=r[w];if(C>=b.width)y+=b.width,T=Math.max(T,b.height),C-=b.width,x+=b.str,w++;else break}if(x){f=Math.max(f,y);let b=T+s*2;g+=b,d.push({text:x,x:0,y:m,width:y,height:T}),m+=b}}}else{let m="",w=c;for(let C=0;C<r.length;C++){let x=r[C];if(w>=x.width)f+=x.width,g=Math.max(g,x.height),m+=x.str,w-=x.width;else break}d.push({text:m,x:0,y:0,width:f,height:g})}if(g=Math.max(g,n*_.lineHeight),f+=s,g+=s,f<=c&&g<=h){let m=l+s,w=a+(h-g)/2+s;o===0?w=a+s:o===2&&(w=a+(h-g)+s),e?.horizontalAlign===1?m=l+(c-f)/2:e?.horizontalAlign===2&&(m=l+(c-f)-s);for(let C of d)C.x=C.x+m,C.y=C.y+w}return{width:f,height:g,resultList:d}}function X(r){return{textAlign:"center",textBaseline:"middle",font:k(void 0,"500",u(12)),fillStyle:v("black",r),lineWidth:p,strokeStyle:v("borderColor",r)}}var ut=Math.max(...Object.values(L)),E=class{constructor(t){this.width=0;this.height=0;this.isRendering=!1;this.rowMap={};this.colMap={};this.eventData={theme:"light",sheetData:{},canvasSize:{top:0,left:0,width:0,height:0},headerSize:{width:0,height:0},currentSheetInfo:{isHide:!1,rowCount:0,colCount:0,name:"",sheetId:"",tabColor:"",sort:1},scroll:{left:0,top:0,row:0,col:0,scrollLeft:0,scrollTop:0},range:{row:0,col:0,rowCount:1,colCount:1,sheetId:""},copyRange:void 0,customHeight:{},customWidth:{},currentMergeCells:[],autoFilter:void 0};this.canvas=t,this.ctx=t.getContext("2d");let e=W();this.ctx.scale(e,e)}render(t){if(t.changeSet.size===0||this.isRendering)return;this.isRendering=!0,this.eventData=t,this.clear();let{ctx:e}=this;e.strokeStyle=v("primaryColor",t.theme),e.fillStyle=v("white",t.theme),e.lineWidth=p*2;let{width:i,height:n}=this.eventData.canvasSize,s=this.eventData.headerSize,{endRow:o,contentHeight:l}=this.renderRowsHeader(n),{endCol:a,contentWidth:h}=this.renderColsHeader(i);this.renderGrid(i-s.width,n-s.height),this.renderTriangle(),this.renderMergeCell(),this.ctx.fillStyle=v("selectionColor",this.eventData.theme);let c=this.renderSelection({endRow:o,endCol:a,contentHeight:l,contentWidth:h});return this.renderAntLine(c),this.renderContent({endRow:o,endCol:a,contentHeight:l,contentWidth:h}),this.ctx.lineWidth=ut,B(this.ctx,c.left,c.top,c.width,c.height),this.isRendering=!1,{rowMap:{...this.rowMap},colMap:{...this.colMap}}}resize(t){this.width=t.width,this.height=t.height,this.canvas.width=u(t.width),this.canvas.height=u(t.height)}clear(){K(this.ctx,0,0,this.width,this.height)}renderRowsHeader(t){let{row:e}=this.eventData.scroll,i=this.eventData.headerSize,{rowCount:n}=this.eventData.currentSheetInfo;this.ctx.save();let s=this.eventData.range;R(this.ctx,0,i.height,i.width,t),Object.assign(this.ctx,X(this.eventData.theme));let o=[],l=i.height,a=e;for(;a<n&&l<t;a++){let c=this.getRowHeight(a),d=l;if(a===e&&(d+=p/2),o.push([0,d],[i.width,d]),c>0){let f=this.isHighlightRow(s,a);this.ctx.fillStyle=f?v("primaryColor",this.eventData.theme):v("black",this.eventData.theme),G(this.ctx,String(a+1),i.width/2,d+c/2)}l+=c}o.push([0,l],[i.width,l]),o.push([0,0],[0,l]),I(this.ctx,o),this.ctx.restore();let h=a>=n?l:t;return{endRow:a,contentHeight:Math.floor(h)}}renderColsHeader(t){let{col:e,row:i}=this.eventData.scroll,n=this.eventData.headerSize,{colCount:s}=this.eventData.currentSheetInfo,o=this.eventData.range,l=[];this.ctx.save(),R(this.ctx,n.width,0,t,n.height),Object.assign(this.ctx,X());let a=n.width,h=e,c=this.eventData.autoFilter,d=0;for(let g=i;g<this.eventData.currentSheetInfo.rowCount&&(d=this.getRowHeight(i),d===0);g++);for(;h<s&&a<=t;h++){let g=this.getColWidth(h),m=a;if(h===e&&(m+=p/2),l.push([m,0],[m,n.height]),g>0){let w=this.isHighlightCol(o,h);this.ctx.fillStyle=w?v("primaryColor",this.eventData.theme):v("black",this.eventData.theme),G(this.ctx,nt(h),m+g/2,n.height/2)}c&&h>=c.range.col&&h<c.range.col+c.range.colCount&&this.renderFilter(a+g,n.height+d,c.col===h),a+=g}l.push([a,0],[a,n.height]),l.push([0,0],[a,0]),I(this.ctx,l),this.ctx.restore();let f=h>=s?a:t;return{endCol:h,contentWidth:Math.floor(f)}}renderFilter(t,e,i){let n=16,s=p*4,o=t-n-s,l=e-n-s;this.ctx.fillStyle=i?v("primaryColor",this.eventData.theme):v("borderColor",this.eventData.theme),this.ctx.strokeStyle=i?v("primaryColor",this.eventData.theme):v("borderColor",this.eventData.theme),B(this.ctx,o,l,n,n),V(this.ctx,[o+n/4,l+n*3/8],[o+n*3/4,l+n*3/8],[o+n/2,l+n*5/8])}renderGrid(t,e){let i=this.eventData.headerSize,{row:n,col:s}=this.eventData.scroll,{rowCount:o,colCount:l}=this.eventData.currentSheetInfo;this.ctx.save(),this.ctx.lineWidth=p,this.ctx.strokeStyle=v("borderColor",this.eventData.theme),this.ctx.translate(u(i.width),u(i.height));let a=[],h=0,c=0;for(let d=n;d<o&&h<=e;d++){for(;d<o&&this.getRowHeight(d)===0;)d++;a.push([0,h],[t,h]);let f=this.getRowHeight(d);h+=f}for(let d=s;d<l&&c<=t;d++){for(;d<l&&this.getColWidth(d)===0;)d++;a.push([c,0],[c,h]);let f=this.getColWidth(d);c+=f}a.push([0,h],[c,h]),a.push([c,0],[c,h]),I(this.ctx,a),this.ctx.restore()}renderTriangle(){let t=this.eventData.headerSize;this.ctx.save(),R(this.ctx,0,0,t.width,t.height),this.ctx.fillStyle=v("triangleFillColor",this.eventData.theme);let e=2,i=Math.floor(e),n=Math.floor(t.height-e),s=Math.floor(t.width*.4),o=Math.floor(t.width-e);V(this.ctx,[o,i],[s,n],[o,n]),this.ctx.restore()}getRowHeight(t){let e=q(this.eventData.currentSheetInfo.sheetId,t),i=this.eventData.customHeight[e];return i?i.isHide?0:i.len:22}getColWidth(t){let e=q(this.eventData.currentSheetInfo.sheetId,t),i=this.eventData.customWidth[e];return i?i.isHide?0:i.len:76}isHighlightRow(t,e){return!!(P(t)||O(t)||e>=t.row&&e<t.row+t.rowCount)}isHighlightCol(t,e){return!!(P(t)||A(t)||e>=t.col&&e<t.col+t.colCount)}renderAntLine(t){let e=this.eventData.copyRange;!e||e.sheetId!==this.eventData.currentSheetInfo.sheetId||(this.ctx.lineWidth=ut,this.ctx.strokeStyle=v("primaryColor",this.eventData.theme),at(this.ctx,t.left,t.top,t.width,t.height))}renderMergeCell(){let t=this.eventData.currentMergeCells;if(t.length===0)return;let e=this.eventData.range;for(let i of t)e.row===i.row&&e.col===i.col||this.clearRect(i)}getCellSize(t){let{row:e,col:i,colCount:n,rowCount:s}=t,o=e,l=i,a=e+s,h=i+n,c=this.eventData.currentSheetInfo;P(t)?(l=0,h=c.colCount,o=0,a=c.rowCount):O(t)?(o=0,a=c.rowCount):A(t)&&(l=0,h=c.colCount);let d=0,f=0;for(;o<a;o++)f+=this.getRowHeight(o);for(;l<h;l++)d+=this.getColWidth(l);return{width:d,height:f}}computeCellPosition(t){let{row:e,col:i}=t,n=this.eventData.headerSize,s=this.eventData.scroll,o=n.width,l=n.height,a=s.row,h=s.col;if(i>=s.col)for(;h<i;)o+=this.getColWidth(h),h++;else for(o=-n.width;h>i;)o-=this.getColWidth(h),h--;if(e>=s.row)for(;a<e;)l+=this.getRowHeight(a),a++;else for(l=-n.height;a>e;)l-=this.getRowHeight(a),a--;return{top:l,left:o}}getActiveRange(t){let e=t||this.eventData.range,i=this.eventData.currentMergeCells;for(let n of i)if(ot(e,n))return{range:{...n,sheetId:n.sheetId},isMerged:!0};return{range:e,isMerged:!1}}clearRect(t){let e=this.getCellSize(t);if(e.width<=0||e.height<=0)return;let i=this.computeCellPosition(t),n=p;K(this.ctx,i.left+n,i.top+n,e.width-n*2,e.height-n*2)}renderContent(t){let{endCol:e,endRow:i,contentHeight:n,contentWidth:s}=t,{ctx:o}=this;o.textAlign="left",o.textBaseline="top",o.lineWidth=p*2;let l=this.eventData.headerSize,{row:a,col:h}=this.eventData.scroll,c=Math.floor(s-l.width),d=Math.floor(n-l.height);o.save(),this.rowMap={},this.colMap={};let f=this.eventData.currentMergeCells;for(let g=a;g<i;g++)for(let m=h;m<e;m++){let w=f.find(C=>C.row===g&&C.col===m);this.renderCell(g,m,w,c,d)}o.restore()}renderCell(t,e,i,n,s){let{ctx:o}=this,l={row:t,col:e,rowCount:1,colCount:1,sheetId:""},a=tt(t,e),h=this.eventData.sheetData[a];if(!h)return;let c=this.getCellSize(i||l);if(c.width<=0||c.height<=0)return;let d=this.computeCellPosition(l);o.lineWidth=p*2;let f=this.eventData.theme,g=ct(o,{top:d.top,left:d.left,width:Math.min(c.width,n),height:Math.min(c.height,s)},h.value,h.style,!!i,f),m=Math.max(this.rowMap[t]??0,g.height),w=Math.max(this.colMap[e]??0,g.width);m>=22&&(this.rowMap[t]=m),w>=76&&(this.colMap[e]=w);let C={top:d.top,left:d.left,height:Math.max(m,c.height),width:Math.max(w,c.width)};H(o,C,h.style?.borderTop,"top",f),H(o,C,h.style?.borderBottom,"bottom",f),H(o,C,h.style?.borderLeft,"left",f),H(o,C,h.style?.borderRight,"right",f)}renderSelection(t){let e=this.eventData.range;return P(e)?this.renderSelectAll(t):O(e)?this.renderSelectCol(t):A(e)?this.renderSelectRow(t):this.renderSelectRange()}renderSelectRange(){let t=this.eventData.headerSize,e=this.eventData.range,i=this.computeCellPosition({row:e.row,col:e.col,rowCount:1,colCount:1,sheetId:""}),n=e.row+e.rowCount-1,s=e.col+e.colCount-1,o={row:n,col:s,rowCount:1,colCount:1,sheetId:""},l=this.computeCellPosition(o),a=this.getCellSize(o),h=l.left+a.width-i.left,c=l.top+a.height-i.top;R(this.ctx,i.left,0,h,t.height),R(this.ctx,0,i.top,t.width,c);let d=e.rowCount>1||e.colCount>1;d&&R(this.ctx,i.left,i.top,h,c);let f=[[i.left,t.height],[i.left+h,t.height]];return f.push([t.width,i.top],[t.width,i.top+c]),I(this.ctx,f),d&&this.renderActiveCell(),{left:i.left,top:i.top,width:h,height:c}}renderSelectAll(t){let{contentHeight:e,contentWidth:i}=t,n=this.eventData.headerSize;R(this.ctx,0,0,i,e),this.renderActiveCell();let s=i-n.width,o=e-n.height;return{left:n.width,top:n.height,width:s,height:o}}renderSelectCol({contentHeight:t}){let e=this.eventData.headerSize,i=this.eventData.range,n=this.computeCellPosition(i),s=0;for(let a=i.col,h=i.col+i.colCount;a<h;a++)s+=this.getColWidth(a);let o=t-e.height;R(this.ctx,n.left,0,s,t),R(this.ctx,0,n.top,e.width,o);let l=[[e.width,e.height],[e.width,t]];return I(this.ctx,l),this.renderActiveCell(),{left:n.left,top:e.height,width:s,height:o}}renderSelectRow({contentWidth:t}){let e=this.eventData.headerSize,i=this.eventData.range,n=this.computeCellPosition(i),s=0;for(let a=i.row,h=i.row+i.rowCount;a<h;a++)s+=this.getRowHeight(a);let o=t-e.width-p;R(this.ctx,n.left,0,o,e.height),R(this.ctx,0,n.top,t,s);let l=[[n.left,e.height],[t,e.height]];return I(this.ctx,l),this.renderActiveCell(),{left:e.width,top:n.top,width:o,height:s}}renderActiveCell(){let t=this.eventData.range,e=this.getActiveRange({row:t.row,col:t.col,rowCount:1,colCount:1,sheetId:t.sheetId}).range;this.clearRect(e)}};var Z=null,xt={init(r){Z=new E(r.canvas),it(r.dpr)},resize(r){Z?.resize(r)},async render(r,t){let e=Z?.render(r);e&&await t(e)},computeFormulas:ht},se=xt;export{se as a};
//# sourceMappingURL=chunk-COPFB74N.js.map
