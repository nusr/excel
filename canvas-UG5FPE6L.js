/* 
MIT License

Copyright (c) 2020 Steve Xu

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
import{a as pt,b as gt,d as Ct,e as vt,f as bt,g as wt,h as St,i as Et}from"./chunk-OSIJK276.js";import{c as yt}from"./chunk-NAXLYV6U.js";import{a as Q,b as F,c as D,d as G,e as L,f as mt,g as ht,h as ft}from"./chunk-JDBCPFQN.js";import"./chunk-GVI256NM.js";import{e as Nt,f as Mt}from"./chunk-R7J4CDNN.js";import"./chunk-PRJU7QU5.js";import{A as ut,I as dt,K as E,O as It,T as xt,X as Tt,a as _,d as rt,j as C,l as it,u as N,v as ct,w as B,x as W}from"./chunk-YWIWGZ5Y.js";import{J as nt,a as tt,g as et,i as X,j as ot,ja as lt,o as U,q as H,va as at,y as Y,ya as st}from"./chunk-456IQKKT.js";import{c as O}from"./chunk-AI5EXC2Q.js";var S=O(_());var I={"canvas-container":"vo","vertical-scroll-bar":"uo","vertical-scroll-bar-content":"I","horizontal-scroll-bar":"fo","horizontal-scroll-bar-content":"Z","context-menu":"B","bottom-bar":"H",active:"mo","bottom-bar-text":"wo","bottom-bar-input":"yo","add-button":"ko"};var v=O(_());function Lt(e,t,o){let n=e.getScroll(),{maxHeight:r,maxScrollHeight:i,maxScrollWidth:m,maxWidth:c}=Ct(n.left,n.top),l=n.scrollTop+Math.ceil(o),u=n.scrollLeft+Math.ceil(t);l<0?l=0:l>i&&(l=i),u<0?u=0:u>m&&(u=m);let s=Math.floor(r*l/i),a=Math.floor(c*u/m),{row:h,col:g}=pt(e,a,s),p={top:s,left:a,row:h,col:g,scrollLeft:u,scrollTop:l},b=e.getActiveRange().range;return p.row!=n.row&&(b.row=p.row),p.col!==n.col&&(b.col=p.col),e.setScroll(p),p}var Pt={prevPageX:0,prevPageY:0,scrollStatus:0},$=(0,v.memo)(({controller:e})=>{let t=(0,v.useRef)({...Pt}),{scrollLeft:o,scrollTop:n}=(0,v.useSyncExternalStore)(L.subscribe,L.getSnapshot),[r]=(0,v.useMemo)(()=>{function l(){t.current={...Pt},s(!1)}function u(a){if(a.buttons<=0){s(!1);return}t.current.scrollStatus!==0&&(t.current.scrollStatus===1?(Lt(e,0,a.clientY-t.current.prevPageY),t.current.prevPageY=a.clientY):t.current.scrollStatus===2&&(Lt(e,a.clientX-t.current.prevPageX,0),t.current.prevPageX=a.clientX))}function s(a){let h=a?document.addEventListener:document.removeEventListener;h("pointermove",u),h("pointerup",l)}return[s]},[]);(0,v.useEffect)(()=>r,[r]);let i=(0,v.useCallback)((l,u)=>{l.buttons<=0||(r(!0),t.current.prevPageX=l.clientX,t.current.prevPageY=l.clientY,t.current.scrollStatus=u)},[r]),m=(0,v.useCallback)(l=>{i(l,1)},[i]),c=(0,v.useCallback)(l=>{i(l,2)},[r]);return v.default.createElement(v.Fragment,null,v.default.createElement("div",{className:I["vertical-scroll-bar"],"data-testid":"vertical-scroll-bar",onPointerDown:m},v.default.createElement("div",{className:I["vertical-scroll-bar-content"],style:{transform:`translateY(${n}px)`},"data-testid":"vertical-scroll-bar-content"})),v.default.createElement("div",{className:I["horizontal-scroll-bar"],"data-testid":"horizontal-scroll-bar",onPointerDown:c},v.default.createElement("div",{className:I["horizontal-scroll-bar-content"],style:{transform:`translateX(${o}px)`},"data-testid":"horizontal-scroll-bar-content"})))});$.displayName="ScrollBar";var d=O(_());var At=110,K=20;function Dt(e,t){let o=B.get(),n=N.get(),r=3,i=K*3,m=e-n.top,c=t-n.left;m<o.height&&c<o.width?r=2:m<o.height?(r=0,i=K*6):c<o.width&&(r=1,i=K*6);let l=e,u=t,s=18,a=n.height+n.top;return l+i>a&&(l=a-i-s),u+At>n.width&&(u=n.width-At-s),{style:{top:l,left:u},position:r}}var Z=1e4,j=(0,d.memo)(e=>{let{controller:t,top:o,left:n,hideContextMenu:r}=e,{row:i,col:m,colCount:c,rowCount:l}=(0,d.useSyncExternalStore)(F.subscribe,F.getSnapshot),[u]=It(r),{style:s,position:a}=(0,d.useMemo)(()=>Dt(o,n),[o,n]),h=g=>{let p=g?t.getRowHeight(i).len:t.getColWidth(m).len,b=f=>{let w=parseInt(f.target.value,10);isNaN(w)||(w<0?p=0:p>Z?p=Z:p=w),f.stopPropagation()};xt({visible:!0,title:g?C("row-height"):C("column-width"),testId:"context-menu-width-height-dialog",children:d.default.createElement("input",{type:"number",min:0,max:Z,style:{width:"200px"},defaultValue:p,onChange:b,"data-testid":"context-menu-width-height-dialog-input"}),onOk:()=>{if(p<0)return Tt.error(C("greater-than-zero"));g?t.batchUpdate(()=>{for(let f=0;f<l;f++)t.setRowHeight(i+f,p);return!0}):t.batchUpdate(()=>{for(let f=0;f<c;f++)t.setColWidth(m+f,p);return!0}),r()},onCancel:()=>{r()}})};return d.default.createElement("div",{className:I["context-menu"],"data-testid":"context-menu",style:s,ref:u},d.default.createElement(E,{onClick:()=>{r(),t.setFloatElementUuid(""),t.copy()},testId:"context-menu-copy"},C("copy")),d.default.createElement(E,{onClick:()=>{r(),t.setFloatElementUuid(""),t.cut()},testId:"context-menu-cut"},C("cut")),d.default.createElement(E,{testId:"context-menu-paste",onClick:()=>{r(),t.paste()}},C("paste")),(a===1||a===3)&&d.default.createElement(d.Fragment,null,d.default.createElement(E,{testId:"context-menu-insert-row-above",onClick:()=>{r(),t.addRow(i,l,!0)}},C("insert-row-above")),d.default.createElement(E,{testId:"context-menu-insert-row-below",onClick:()=>{r(),t.addRow(i,l)}},C("insert-row-below"))),(a===0||a===3)&&d.default.createElement(d.Fragment,null,d.default.createElement(E,{testId:"context-menu-insert-column-left",onClick:()=>{r(),t.addCol(m,c)}},C("insert-column-left")),d.default.createElement(E,{testId:"context-menu-insert-column-right",onClick:()=>{r(),t.addCol(m,c,!0)}},C("insert-column-right"))),a===2&&d.default.createElement(E,{testId:"context-menu-delete",onClick:()=>{r(),t.deleteAll(t.getCurrentSheetId())}},C("delete")),a===0&&d.default.createElement(d.Fragment,null,d.default.createElement(E,{testId:"context-menu-delete-column",onClick:()=>{r(),t.deleteCol(m,c)}},C("delete-columns")),d.default.createElement(E,{testId:"context-menu-hide-column",onClick:()=>{r(),t.hideCol(m,c)}},C("hide-columns")),d.default.createElement(E,{testId:"context-menu-column-width",onClick:()=>{h(!1)}},C("column-width"))),a===1&&d.default.createElement(d.Fragment,null,d.default.createElement(E,{testId:"context-menu-delete-row",onClick:()=>{r(),t.deleteRow(i,l)}},C("delete-rows")),d.default.createElement(E,{testId:"context-menu-hide-row",onClick:()=>{r(),t.hideRow(i,l)}},C("hide-rows")),d.default.createElement(E,{testId:"context-menu-row-height",onClick:()=>{h(!0)}},C("row-height"))))});j.displayName="CanvasContextMenu";function zt(e,t){let{row:o,col:n,rowCount:r,colCount:i,sheetId:m}=e,c={labels:[],datasets:[]};for(let l=o,u=1,s=o+r;l<s;l++,u++){if(t.getRowHeight(l).len===et)continue;let h=[];for(let g=n,p=n+i;g<p;g++){let b=t.getCell({row:l,col:g,rowCount:1,colCount:1,sheetId:m});b&&h.push(nt(b.value)[1])}h.length>0&&c.datasets.push({label:`Series${u}`,data:h})}return c.datasets[0]&&c.datasets[0].data.length>0&&(c.labels=Array.from({length:c.datasets[0].data.length}).fill("").map((l,u)=>String(u+1))),c}function Ot(e){let{top:t}=N.get(),{range:o,isMerged:n}=e.getActiveRange(),r=o.sheetId||e.getCurrentSheetId(),i=e.getCell(o),m=e.getDefineName({row:o.row,col:o.col,rowCount:1,colCount:1,sheetId:r}),c=e.getCellSize(o),l=e.computeCellPosition(o);l.top=t+l.top;let u=i?.style?.fontFamily??"";if(!u){let R="",Bt=G.getSnapshot();for(let J of Bt)if(!J.disabled){R=String(J.value);break}u=R}let{isBold:s=!1,isItalic:a=!1,isStrike:h=!1,fontSize:g=tt,fontColor:p=st("contentColor"),fillColor:b="",isWrapText:f=!1,underline:w=0,horizontalAlign:x,verticalAlign:k}=i?.style||{},T=i?.style?.numberFormat||Y,P=T===Y&&typeof i?.value=="number",M=x;x===void 0&&P&&(M=2);let A=Nt(i?.value,T),z="";if(Mt(T)||T===dt(10))z=A;else{let R=i?.value??"";z=typeof R=="boolean"?R.toString().toUpperCase():String(R),A=z}let V="";n&&(A.includes(X)?(V=String(2),A=A.replaceAll(X,ot)):V=String(0)),F.setState({top:l.top,left:l.left,width:c.width,height:c.height,row:o.row,col:o.col,rowCount:o.rowCount,colCount:o.colCount,value:i?.formula||z,defineName:m,displayValue:i?.formula||A}),ft.setState({isBold:s,isItalic:a,isStrike:h,fontColor:p,fontSize:g,fontFamily:u,fillColor:b,isWrapText:f,underline:w,numberFormat:T,isMergeCell:n,mergeType:V,horizontalAlign:M,verticalAlign:k})}var Rt=(e,t)=>{if((e.has("rangeMap")||e.has("cellStyle")||e.has("cellValue")||e.has("currentSheetId")||e.has("mergeCells"))&&Ot(t),e.has("workbook")){let o=t.getSheetList().map(n=>({sheetId:n.sheetId,name:n.name,isHide:n.isHide,tabColor:n.tabColor||""}));Q.setState(o)}if(e.has("currentSheetId")?D.setState({canRedo:t.canRedo(),canUndo:t.canUndo(),activeUuid:"",currentSheetId:t.getCurrentSheetId()}):D.setState({canRedo:t.canRedo(),canUndo:t.canUndo()}),e.has("scroll")){let o=t.getScroll(),n=N.get(),r=o.scrollTop/n.height>=.91;L.setState({scrollLeft:o.scrollLeft,scrollTop:o.scrollTop,showBottomBar:r})}if(e.has("definedNames")){let o=t.getDefineNameList().map(n=>n.name);ht.setState(o)}if(e.has("drawings")||e.has("cellValue")||e.has("row")||e.has("col")||e.has("currentSheetId")||e.has("scroll")){let o=t.getScroll(),n=N.get(),r=o.left,i=o.top,m=n.width+r,c=n.height+i,l=t.getDrawingList(t.getCurrentSheetId()),u=[];for(let s of l){let a=t.computeCellPosition({row:s.fromRow,col:s.fromCol,colCount:1,rowCount:1,sheetId:""}),h=a.top+s.marginY,g=a.left+s.marginX;if(h>i&&h<c||g>r&&g<m||h+s.height>i&&h+s.height<c||g+s.width>r&&g+s.width<m){let b={...s,top:h,left:g,labels:[],datasets:[]};if(s.type==="chart"){let f=zt(s.chartRange,t);b.labels=f.labels,b.datasets=f.datasets}u.push(b)}}mt.setState(u)}e.has("currentSheetId")&&setTimeout(()=>{gt(t.getCurrentSheetId())},0)};function _t(e){let t=parseInt(at.largePadding,10),o=e.parentElement;if(!o)return null;let n=o.getBoundingClientRect(),r={top:n.top,left:n.left,width:o.clientWidth-t,height:o.clientHeight-t};N.set(r)}function kt(e,t){let o=it();G.setState(o);let n=Et(e,t),r=()=>{i(new Set(["row"]))},i=u=>{_t(t),n.resize(),n.render({changeSet:u})},m=ut.on("modelChange",({changeSet:u})=>{Rt(u,e),n.render({changeSet:u})}),c=St(e,r),l=new Set(["currentSheetId","rangeMap","workbook","worksheets","drawings","definedNames","mergeCells","scroll","cellValue","row","col","cellStyle","undo","redo","antLine"]);return Rt(l,e),i(l),queueMicrotask(()=>{i(l)}),()=>{c(),m()}}var y=O(_());var Ut=10,q=(0,y.memo)(({controller:e})=>{let[t,o]=(0,y.useState)(Ut),{showBottomBar:n}=(0,y.useSyncExternalStore)(L.subscribe,L.getSnapshot),r=m=>{m.stopPropagation();let c=parseInt(m.target.value,10);isNaN(c)||(c<1?o(1):c>U?o(U):o(c))},i=()=>{let m=e.getSheetInfo(e.getCurrentSheetId());e.addRow(m.rowCount-1,t);let c=ct.get();vt(e,0,c.height)};return y.default.createElement("div",{className:rt(I["bottom-bar"],{[I.active]:n}),"data-testid":"canvas-bottom-bar"},y.default.createElement("div",{className:I["bottom-bar-text"]},C("add-at-the-bottom")),y.default.createElement("input",{value:t,onChange:r,type:"number",min:1,max:U,"data-testid":"canvas-bottom-bar-input",className:I["bottom-bar-input"]}),y.default.createElement("div",{className:I["bottom-bar-text"]},C("rows")),y.default.createElement(E,{testId:"canvas-bottom-bar-add",className:I["add-button"],onClick:i},C("add")))});q.displayName="BottomBar";var Vt=300,Ht=(0,S.memo)(e=>{let{controller:t}=e,o=(0,S.useRef)({timeStamp:0}),[n,r]=(0,S.useState)({top:H,left:H}),i=(0,S.useRef)(null);(0,S.useEffect)(()=>{if(!i.current)return;let s=kt(t,i.current);return()=>{s()}},[]);let m=s=>{s.preventDefault(),r({top:s.clientY,left:s.clientX})},c=()=>{r({top:H,left:H})},l=s=>{if(s.buttons<=0)return;let a=B.get(),h=N.get(),{clientX:g=0,clientY:p=0}=s,b=g-h.left,f=p-h.top,w=W(t,b,f);if(!w)return;let{range:x,isMerged:k}=t.getActiveRange({row:w.row,col:w.col,colCount:1,rowCount:1,sheetId:""}),T=t.getActiveRange().range;if(T.row===x.row&&T.col===x.col)return;let P=0,M=0;if(b>a.width&&f>a.height){if(k){t.setActiveRange(x);return}M=Math.abs(w.col-T.col)+1,P=Math.abs(w.row-T.row)+1}a.width>b&&a.height<=f&&(P=Math.abs(w.row-T.row)+1),a.width<=b&&a.height>f&&(M=Math.abs(w.col-T.col)+1),t.setActiveRange({row:Math.min(w.row,T.row),col:Math.min(w.col,T.col),rowCount:P,colCount:M,sheetId:""})},u=s=>{if(s.buttons<=0)return;let a=B.get(),h=N.get(),{timeStamp:g,clientX:p=0,clientY:b=0}=s,f=p-h.left,w=b-h.top,x=W(t,f,w);if(!x)return;if(a.width>f&&a.height>w){t.setActiveRange({row:0,col:0,colCount:0,rowCount:0,sheetId:""});return}if(a.width>f&&a.height<=w){t.setActiveRange({row:x.row,col:x.col,rowCount:1,colCount:0,sheetId:""});return}if(a.width<=f&&a.height>w){t.setActiveRange({row:x.row,col:x.col,rowCount:0,colCount:1,sheetId:""});return}let{range:k}=t.getActiveRange({row:x.row,col:x.col,colCount:1,rowCount:1,sheetId:t.getCurrentSheetId()}),T=t.getActiveRange().range;lt(T,k)?g-o.current.timeStamp<Vt&&D.setState(M=>M.editorStatus===1?M:{editorStatus:1}):(bt()&&wt(t),t.setActiveRange({row:x.row,col:x.col,rowCount:1,colCount:1,sheetId:""})),o.current.timeStamp=g};return S.default.createElement(S.Fragment,null,S.default.createElement("div",{className:I["canvas-container"],"data-testid":"canvas-container"},S.default.createElement("canvas",{className:I["canvas-content"],onContextMenu:m,onPointerMove:l,onPointerDown:u,ref:i,"data-testid":"canvas-main"}),S.default.createElement($,{controller:t}),S.default.createElement(q,{controller:t}),S.default.createElement(yt,{controller:t})),n.top>=0&&n.left>=0&&S.default.createElement(j,{...n,controller:t,hideContextMenu:c}))});Ht.displayName="CanvasContainer";var De=Ht;export{Ht as CanvasContainer,De as default};
//# sourceMappingURL=canvas-UG5FPE6L.js.map
