/* 
MIT License

Copyright (c) 2020 Steve Xu

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
import{d as ht,e as lt,f as at}from"./chunk-R7J4CDNN.js";import{A as tt,B as m,C as E,G as et,M as it,O as j,W as nt,Z as L,a as W,c as q,ca as P,d as G,da as g,ea as ot,fa as rt,g as N,ga as H,ha as O,i as U,ia as k,ka as st,va as _,y as Y,ya as v}from"./chunk-456IQKKT.js";function K(n){return n?typeof Intl>"u"||typeof Intl.Segmenter!="function"?[...n]:[...new Intl.Segmenter([],{granularity:"word"}).segment(n)].map(i=>i.segment):[]}var V=new Map;function mt(n,t){let e=`${t}__${n.font}`;if(V.has(e))return V.get(e);let i=n.measureText(t),{actualBoundingBoxAscent:r,actualBoundingBoxDescent:s}=i,o=r+s,h=i.width,l=Math.ceil(h/P()),a=Math.ceil(o/P()),c={width:l,height:a};return V.set(e,c),c}function D(n,t,e,i,r){n.fillRect(g(t),g(e),g(i),g(r))}function X(n,t,e,i,r){n.strokeRect(g(t),g(e),g(i),g(r))}function Z(n,t,e,i,r){n.clearRect(g(t),g(e),g(i),g(r))}function F(n,t,e,i){n.fillText(t,g(e),g(i))}function T(n,t){if(t.length!==0){n.beginPath();for(let e=0;e<t.length;e+=2){let i=t[e],r=t[e+1];n.moveTo(g(i[0]),g(i[1])),n.lineTo(g(r[0]),g(r[1]))}n.stroke()}}function ct(n,t,e,i){n.beginPath(),n.moveTo(g(t[0]),g(t[1])),n.lineTo(g(e[0]),g(e[1])),n.lineTo(g(i[0]),g(i[1])),n.fill()}function dt(n,t,e){let i=n.slice(),[r,s]=n,o=m*2,h=e?o:0;return t==="bottom"?i.push([r[0]+h,r[1]-o],[s[0]-h,s[1]-o]):t==="top"?i.push([r[0]+h,r[1]+o],[s[0]-h,s[1]+o]):t==="left"?i.push([r[0]+o,r[1]+h],[s[0]+o,s[1]-h]):t==="right"&&i.push([r[0]-o,r[1]+h],[s[0]-o,s[1]-h]),i}function pt(n,t,e){return e?t?n.split(U):K(n.replaceAll(U,"")):K(n)}function ft(n,t,e,i,r){n.setLineDash([g(8),g(6)]);let s=m;X(n,t+s,e+s,i-s*2,r-s*2),n.setLineDash([])}function Ct(n){let t=[];return n==="hair"?t=[m,m]:n==="dotted"||n==="mediumDashed"?t=[m*2,m*2]:n==="dashed"?t=[m*4,m*4]:n==="dashDot"||n==="mediumDashDot"?t=[m*4,m*4,m*8,m*4]:(n==="dashDotDot"||n==="mediumDashDotDot")&&(t=[m*4,m*4,m*8,m*4,m*4,m*4]),t}function A(n,t,e,i,r){if(!e)return;let{top:s,left:o,width:h,height:l}=t,a=[];i==="top"?a=[[o,s],[o+h,s]]:i==="bottom"?a=[[o,s+l],[o+h,s+l]]:i==="left"?a=[[o,s],[o,s+l]]:i==="right"&&(a=[[o+h,s],[o+h,s+l]]);let{type:c,color:d}=e;n.lineWidth=E[c],n.strokeStyle=d||v("black",r);let f=Ct(c);c==="double"&&(a=dt(a,i,!0)),f.length>0&&n.setLineDash(f.map(u=>g(u))),T(n,a),f.length>0&&n.setLineDash([])}function gt(n,t,e,i,r,s){let o={height:0,width:0};if(e===""&&et(i))return o;let h=i?.numberFormat||Y,l=h===Y&&typeof e=="number",a=lt(e,h),c=i?.fontSize?i.fontSize:W,d=L(i?.isItalic?"italic":"normal",i?.isBold?"bold":"500",g(c),i?.fontFamily);i?.fillColor&&(n.fillStyle=i?.fillColor,D(n,t.left,t.top,t.width,t.height));let f=i?.fontColor||v("contentColor",s);tt.has(a)&&(f=v("errorFormulaColor",s)),n.font=d,n.fillStyle=f;let u=i?{...i}:{},p=u?.horizontalAlign;u?.horizontalAlign===void 0&&l&&(p=2),u.horizontalAlign=p;let x=(!u?.isWrapText&&at(h)?[a]:pt(a,i?.isWrapText,r)).map(y=>{let S=mt(n,y);return{str:y,width:S.width,height:S.height===0?c:S.height}}),{width:z,height:I,resultList:b}=wt(x,t,u,nt(!!r,a));if(z>0&&I>0){let y=Math.ceil(c*(_.lineHeight-1)/2),S=[];for(let R of b){if(F(n,R.text,R.x,R.y),u?.underline){n.strokeStyle=f;let M=R.y+R.height+y/2,Q=[[R.x,M],[R.x+R.width,M]];u?.underline===2?S=S.concat(dt(Q,"bottom",!1)):S=S.concat(Q)}if(u?.isStrike){n.strokeStyle=f;let M=R.y+R.height/2+y/2;S=S.concat([[R.x,M],[R.x+R.width,M]])}}T(n,S)}return o.height=Math.ceil(I),o.width=Math.ceil(z),o}function wt(n,t,e,i){let r=e?.fontSize?e.fontSize:W,s=Math.ceil(r*(_.lineHeight-1)/2),o=e?.verticalAlign??1,{left:h,top:l,height:a}=t,c=Math.max(t.width,...n.map(p=>p.width)),d=[],f=0,u=0;if(e?.isWrapText&&i){let p=0;for(let w=0;w<n.length;w++){let C=n[w];f=Math.max(f,C.width);let x=C.height+s*2;u+=x,d.push({text:C.str,x:0,y:p,width:C.width,height:C.height}),p+=x}}else if(e?.isWrapText){let p=0;for(let w=0;w<n.length;){let C=c,x="",z=0,I=0;for(;w<n.length;){let b=n[w];if(C>=b.width)z+=b.width,I=Math.max(I,b.height),C-=b.width,x+=b.str,w++;else break}if(x){f=Math.max(f,z);let b=I+s*2;u+=b,d.push({text:x,x:0,y:p,width:z,height:I}),p+=b}}}else{let p="",w=c;for(let C=0;C<n.length;C++){let x=n[C];if(w>=x.width)f+=x.width,u=Math.max(u,x.height),p+=x.str,w-=x.width;else break}d.push({text:p,x:0,y:0,width:f,height:u})}if(u=Math.max(u,r*_.lineHeight),f+=s,u+=s,f<=c&&u<=a){let p=h+s,w=l+(a-u)/2+s;o===0?w=l+s:o===2&&(w=l+(a-u)+s),e?.horizontalAlign===1?p=h+(c-f)/2:e?.horizontalAlign===2&&(p=h+(c-f)-s);for(let C of d)C.x=C.x+p,C.y=C.y+w}return{width:f,height:u,resultList:d}}function $(n){return{textAlign:"center",textBaseline:"middle",font:L(void 0,"500",g(W)),fillStyle:v("black",n),lineWidth:m,strokeStyle:v("borderColor",n)}}var ut=Math.max(...Object.values(E)),B=class{constructor(t){this.width=0;this.height=0;this.isRendering=!1;this.rowMap={};this.colMap={};this.eventData={theme:"light",sheetData:{},canvasSize:{top:0,left:0,width:0,height:0},headerSize:{width:0,height:0},currentSheetInfo:{isHide:!1,rowCount:0,colCount:0,name:"",sheetId:"",tabColor:"",sort:1},scroll:{left:0,top:0,row:0,col:0,scrollLeft:0,scrollTop:0},range:{row:0,col:0,rowCount:1,colCount:1,sheetId:""},copyRange:void 0,customHeight:{},customWidth:{},currentMergeCells:[]};this.canvas=t,this.ctx=t.getContext("2d");let e=P();this.ctx.scale(e,e)}render(t){if(t.changeSet.size===0||this.isRendering)return;this.isRendering=!0,this.eventData=t,this.clear();let{ctx:e}=this;e.strokeStyle=v("primaryColor",t.theme),e.fillStyle=v("white",t.theme),e.lineWidth=m*2;let{width:i,height:r}=this.eventData.canvasSize,s=this.eventData.headerSize,{endRow:o,contentHeight:h}=this.renderRowsHeader(r),{endCol:l,contentWidth:a}=this.renderColsHeader(i);this.renderGrid(i-s.width,r-s.height),this.renderTriangle(),this.renderMergeCell(),this.ctx.fillStyle=v("selectionColor",this.eventData.theme);let c=this.renderSelection({endRow:o,endCol:l,contentHeight:h,contentWidth:a});return this.renderAntLine(c),this.renderContent({endRow:o,endCol:l,contentHeight:h,contentWidth:a}),this.ctx.lineWidth=ut,X(this.ctx,c.left,c.top,c.width,c.height),this.isRendering=!1,{rowMap:this.rowMap,colMap:this.colMap}}resize(t){this.width=t.width,this.height=t.height,this.canvas.width=g(t.width),this.canvas.height=g(t.height)}clear(){Z(this.ctx,0,0,this.width,this.height)}renderRowsHeader(t){let{row:e}=this.eventData.scroll,i=this.eventData.headerSize,{rowCount:r}=this.eventData.currentSheetInfo;this.ctx.save();let s=this.eventData.range;D(this.ctx,0,i.height,i.width,t),Object.assign(this.ctx,$(this.eventData.theme));let o=[],h=i.height,l=e;for(;l<r&&h<t;l++){let c=this.getRowHeight(l),d=h;if(l===e&&(d+=m/2),o.push([0,d],[i.width,d]),c>0){let f=this.isHighlightRow(s,l);this.ctx.fillStyle=f?v("primaryColor",this.eventData.theme):v("black",this.eventData.theme),F(this.ctx,String(l+1),i.width/2,d+c/2)}h+=c}o.push([0,h],[i.width,h]),o.push([0,0],[0,h]),T(this.ctx,o),this.ctx.restore();let a=l>=r?h:t;return{endRow:l,contentHeight:Math.floor(a)}}renderColsHeader(t){let{col:e}=this.eventData.scroll,i=this.eventData.headerSize,{colCount:r}=this.eventData.currentSheetInfo,s=this.eventData.range,o=[];this.ctx.save(),D(this.ctx,i.width,0,t,i.height),Object.assign(this.ctx,$());let h=i.width,l=e;for(;l<r&&h<=t;l++){let c=this.getColWidth(l),d=h;if(l===e&&(d+=m/2),o.push([d,0],[d,i.height]),c>0){let f=this.isHighlightCol(s,l);this.ctx.fillStyle=f?v("primaryColor",this.eventData.theme):v("black",this.eventData.theme),F(this.ctx,rt(l),d+c/2,i.height/2)}h+=c}o.push([h,0],[h,i.height]),o.push([0,0],[h,0]),T(this.ctx,o),this.ctx.restore();let a=l>=r?h:t;return{endCol:l,contentWidth:Math.floor(a)}}renderGrid(t,e){let i=this.eventData.headerSize,{row:r,col:s}=this.eventData.scroll,{rowCount:o,colCount:h}=this.eventData.currentSheetInfo;this.ctx.save(),this.ctx.lineWidth=m,this.ctx.strokeStyle=v("borderColor",this.eventData.theme),this.ctx.translate(g(i.width),g(i.height));let l=[],a=0,c=0;for(let d=r;d<o&&a<=e;d++){for(;d<o&&this.getRowHeight(d)===0;)d++;l.push([0,a],[t,a]);let f=this.getRowHeight(d);a+=f}for(let d=s;d<h&&c<=t;d++){for(;d<h&&this.getColWidth(d)===0;)d++;l.push([c,0],[c,a]);let f=this.getColWidth(d);c+=f}l.push([0,a],[c,a]),l.push([c,0],[c,a]),T(this.ctx,l),this.ctx.restore()}renderTriangle(){let t=this.eventData.headerSize;this.ctx.save(),D(this.ctx,0,0,t.width,t.height),this.ctx.fillStyle=v("triangleFillColor",this.eventData.theme);let e=2,i=Math.floor(e),r=Math.floor(t.height-e),s=Math.floor(t.width*.4),o=Math.floor(t.width-e);ct(this.ctx,[o,i],[s,r],[o,r]),this.ctx.restore()}getRowHeight(t){let e=j(this.eventData.currentSheetInfo.sheetId,t),i=this.eventData.customHeight[e];return i?i.isHide?N:i.len:q}getColWidth(t){let e=j(this.eventData.currentSheetInfo.sheetId,t),i=this.eventData.customWidth[e];return i?i.isHide?N:i.len:G}isHighlightRow(t,e){return!!(H(t)||k(t)||e>=t.row&&e<t.row+t.rowCount)}isHighlightCol(t,e){return!!(H(t)||O(t)||e>=t.col&&e<t.col+t.colCount)}renderAntLine(t){let e=this.eventData.copyRange;!e||e.sheetId!==this.eventData.currentSheetInfo.sheetId||(this.ctx.lineWidth=ut,this.ctx.strokeStyle=v("primaryColor",this.eventData.theme),ft(this.ctx,t.left,t.top,t.width,t.height))}renderMergeCell(){let t=this.eventData.currentMergeCells;if(t.length===0)return;let e=this.eventData.range;for(let i of t)e.row===i.row&&e.col===i.col||this.clearRect(i)}getCellSize(t){let{row:e,col:i,colCount:r,rowCount:s}=t,o=e,h=i,l=e+s,a=i+r,c=this.eventData.currentSheetInfo;H(t)?(h=0,a=c.colCount,o=0,l=c.rowCount):k(t)?(o=0,l=c.rowCount):O(t)&&(h=0,a=c.colCount);let d=0,f=0;for(;o<l;o++)f+=this.getRowHeight(o);for(;h<a;h++)d+=this.getColWidth(h);return{width:d,height:f}}computeCellPosition(t){let{row:e,col:i}=t,r=this.eventData.headerSize,s=this.eventData.scroll,o=r.width,h=r.height,l=s.row,a=s.col;if(i>=s.col)for(;a<i;)o+=this.getColWidth(a),a++;else for(o=-r.width;a>i;)o-=this.getColWidth(a),a--;if(e>=s.row)for(;l<e;)h+=this.getRowHeight(l),l++;else for(h=-r.height;l>e;)h-=this.getRowHeight(l),l--;return{top:h,left:o}}getActiveRange(t){let e=t||this.eventData.range,i=this.eventData.currentMergeCells;for(let r of i)if(st(e,r))return{range:{...r,sheetId:r.sheetId},isMerged:!0};return{range:e,isMerged:!1}}clearRect(t){let e=this.getCellSize(t);if(e.width<=0||e.height<=0)return;let i=this.computeCellPosition(t),r=m;Z(this.ctx,i.left+r,i.top+r,e.width-r*2,e.height-r*2)}renderContent(t){let{endCol:e,endRow:i,contentHeight:r,contentWidth:s}=t,{ctx:o}=this;o.textAlign="left",o.textBaseline="top",o.lineWidth=m*2;let h=this.eventData.headerSize,{row:l,col:a}=this.eventData.scroll,c=Math.floor(s-h.width),d=Math.floor(r-h.height);o.save(),this.rowMap={},this.colMap={};let f=this.eventData.currentMergeCells;for(let u=l;u<i;u++)for(let p=a;p<e;p++){let w=f.find(C=>C.row===u&&C.col===p);this.renderCell(u,p,w,c,d)}o.restore()}renderCell(t,e,i,r,s){let{ctx:o}=this,h={row:t,col:e,rowCount:1,colCount:1,sheetId:""},l=it(t,e),a=this.eventData.sheetData[l];if(!a)return;let c=this.getCellSize(i||h);if(c.width<=0||c.height<=0)return;let d=this.computeCellPosition(h);o.lineWidth=m*2;let f=this.eventData.theme,u=gt(o,{top:d.top,left:d.left,width:Math.min(c.width,r),height:Math.min(c.height,s)},a.value,a.style,!!i,f),p=Math.max(this.rowMap[t]??0,u.height),w=Math.max(this.colMap[e]??0,u.width);p>=q&&(this.rowMap[t]=p),w>=G&&(this.colMap[e]=w);let C={top:d.top,left:d.left,height:Math.max(p,c.height),width:Math.max(w,c.width)};A(o,C,a.style?.borderTop,"top",f),A(o,C,a.style?.borderBottom,"bottom",f),A(o,C,a.style?.borderLeft,"left",f),A(o,C,a.style?.borderRight,"right",f)}renderSelection(t){let e=this.eventData.range;return H(e)?this.renderSelectAll(t):k(e)?this.renderSelectCol(t):O(e)?this.renderSelectRow(t):this.renderSelectRange()}renderSelectRange(){let t=this.eventData.headerSize,e=this.eventData.range,i=this.computeCellPosition({row:e.row,col:e.col,rowCount:1,colCount:1,sheetId:""}),r=e.row+e.rowCount-1,s=e.col+e.colCount-1,o={row:r,col:s,rowCount:1,colCount:1,sheetId:""},h=this.computeCellPosition(o),l=this.getCellSize(o),a=h.left+l.width-i.left,c=h.top+l.height-i.top;D(this.ctx,i.left,0,a,t.height),D(this.ctx,0,i.top,t.width,c);let d=e.rowCount>1||e.colCount>1;d&&D(this.ctx,i.left,i.top,a,c);let f=[[i.left,t.height],[i.left+a,t.height]];return f.push([t.width,i.top],[t.width,i.top+c]),T(this.ctx,f),d&&this.renderActiveCell(),{left:i.left,top:i.top,width:a,height:c}}renderSelectAll(t){let{contentHeight:e,contentWidth:i}=t,r=this.eventData.headerSize;D(this.ctx,0,0,i,e),this.renderActiveCell();let s=i-r.width,o=e-r.height;return{left:r.width,top:r.height,width:s,height:o}}renderSelectCol({contentHeight:t}){let e=this.eventData.headerSize,i=this.eventData.range,r=this.computeCellPosition(i),s=0;for(let l=i.col,a=i.col+i.colCount;l<a;l++)s+=this.getColWidth(l);let o=t-e.height;D(this.ctx,r.left,0,s,t),D(this.ctx,0,r.top,e.width,o);let h=[[e.width,e.height],[e.width,t]];return T(this.ctx,h),this.renderActiveCell(),{left:r.left,top:e.height,width:s,height:o}}renderSelectRow({contentWidth:t}){let e=this.eventData.headerSize,i=this.eventData.range,r=this.computeCellPosition(i),s=0;for(let l=i.row,a=i.row+i.rowCount;l<a;l++)s+=this.getRowHeight(l);let o=t-e.width-m;D(this.ctx,r.left,0,o,e.height),D(this.ctx,0,r.top,t,s);let h=[[r.left,e.height],[t,e.height]];return T(this.ctx,h),this.renderActiveCell(),{left:e.width,top:r.top,width:o,height:s}}renderActiveCell(){let t=this.eventData.range,e=this.getActiveRange({row:t.row,col:t.col,rowCount:1,colCount:1,sheetId:t.sheetId}).range;this.clearRect(e)}};var J=null,vt={init(n){J=new B(n.canvas),ot(n.dpr)},resize(n){J?.resize(n)},async render(n,t){let e=J?.render(n);e&&await t(e)},async computeFormulas(n,t){let i={list:ht(n)};await t(i)}},se=vt;export{se as a};
//# sourceMappingURL=chunk-EE4TWFE7.js.map
