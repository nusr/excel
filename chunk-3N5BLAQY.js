/* 
MIT License

Copyright (c) 2020 Steve Xu

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
import{a as ht,b as lt,d as at}from"./chunk-4ZOIIS26.js";import{A as L,K as et,Q as it,Qa as B,S as j,Ta as v,_ as nt,a as W,aa as O,b as G,c as N,f as U,fa as P,ga as g,h as q,ha as ot,ja as rt,la as H,ma as k,na as _,pa as st,w as Y,y as tt,z as m}from"./chunk-3OL4F4KC.js";function K(o){return o?typeof Intl>"u"||typeof Intl.Segmenter!="function"?[...o]:[...new Intl.Segmenter([],{granularity:"word"}).segment(o)].map(i=>i.segment):[]}var V=new Map;function mt(o,t){let e=`${t}__${o.font}`;if(V.has(e))return V.get(e);let i=o.measureText(t),{actualBoundingBoxAscent:r,actualBoundingBoxDescent:s}=i,n=r+s,h=i.width,l=Math.ceil(h/P()),a=Math.ceil(n/P()),c={width:l,height:a};return V.set(e,c),c}function R(o,t,e,i,r){o.fillRect(g(t),g(e),g(i),g(r))}function X(o,t,e,i,r){o.strokeRect(g(t),g(e),g(i),g(r))}function Z(o,t,e,i,r){o.clearRect(g(t),g(e),g(i),g(r))}function F(o,t,e,i){o.fillText(t,g(e),g(i))}function T(o,t){if(t.length!==0){o.beginPath();for(let e=0;e<t.length;e+=2){let i=t[e],r=t[e+1];o.moveTo(g(i[0]),g(i[1])),o.lineTo(g(r[0]),g(r[1]))}o.stroke()}}function ct(o,t,e,i){o.beginPath(),o.moveTo(g(t[0]),g(t[1])),o.lineTo(g(e[0]),g(e[1])),o.lineTo(g(i[0]),g(i[1])),o.fill()}function dt(o,t,e){let i=o.slice(),[r,s]=o,n=m*2,h=e?n:0;return t==="bottom"?i.push([r[0]+h,r[1]-n],[s[0]-h,s[1]-n]):t==="top"?i.push([r[0]+h,r[1]+n],[s[0]-h,s[1]+n]):t==="left"?i.push([r[0]+n,r[1]+h],[s[0]+n,s[1]-h]):t==="right"&&i.push([r[0]-n,r[1]+h],[s[0]-n,s[1]-h]),i}function pt(o,t,e){return e?t?o.split(q):K(o.replaceAll(q,"")):K(o)}function ft(o,t,e,i,r){o.setLineDash([g(8),g(6)]);let s=m;X(o,t+s,e+s,i-s*2,r-s*2),o.setLineDash([])}function Ct(o){let t=[];return o==="hair"?t=[m,m]:o==="dotted"||o==="mediumDashed"?t=[m*2,m*2]:o==="dashed"?t=[m*4,m*4]:o==="dashDot"||o==="mediumDashDot"?t=[m*4,m*4,m*8,m*4]:(o==="dashDotDot"||o==="mediumDashDotDot")&&(t=[m*4,m*4,m*8,m*4,m*4,m*4]),t}function A(o,t,e,i,r){if(!e)return;let{top:s,left:n,width:h,height:l}=t,a=[];i==="top"?a=[[n,s],[n+h,s]]:i==="bottom"?a=[[n,s+l],[n+h,s+l]]:i==="left"?a=[[n,s],[n,s+l]]:i==="right"&&(a=[[n+h,s],[n+h,s+l]]);let{type:c,color:d}=e;o.lineWidth=L[c],o.strokeStyle=d||v("black",r);let f=Ct(c);c==="double"&&(a=dt(a,i,!0)),f.length>0&&o.setLineDash(f.map(u=>g(u))),T(o,a),f.length>0&&o.setLineDash([])}function gt(o,t,e,i,r,s){let n={height:0,width:0};if(e===""&&et(i))return n;let h=i?.numberFormat||Y,l=h===Y&&typeof e=="number",a=ht(e,h),c=i?.fontSize?i.fontSize:W,d=O(i?.isItalic?"italic":"normal",i?.isBold?"bold":"500",g(c),i?.fontFamily);i?.fillColor&&(o.fillStyle=i?.fillColor,R(o,t.left,t.top,t.width,t.height));let f=i?.fontColor||v("contentColor",s);tt.has(a)&&(f=v("errorFormulaColor",s)),o.font=d,o.fillStyle=f;let u=i?{...i}:{},p=u?.horizontalAlign;u?.horizontalAlign===void 0&&l&&(p=2),u.horizontalAlign=p;let x=(!u?.isWrapText&&lt(h)?[a]:pt(a,i?.isWrapText,r)).map(y=>{let S=mt(o,y);return{str:y,width:S.width,height:S.height===0?c:S.height}}),{width:z,height:I,resultList:b}=wt(x,t,u,nt(!!r,a));if(z>0&&I>0){let y=Math.ceil(c*(B.lineHeight-1)/2),S=[];for(let D of b){if(F(o,D.text,D.x,D.y),u?.underline){o.strokeStyle=f;let M=D.y+D.height+y/2,Q=[[D.x,M],[D.x+D.width,M]];u?.underline===2?S=S.concat(dt(Q,"bottom",!1)):S=S.concat(Q)}if(u?.isStrike){o.strokeStyle=f;let M=D.y+D.height/2+y/2;S=S.concat([[D.x,M],[D.x+D.width,M]])}}T(o,S)}return n.height=Math.ceil(I),n.width=Math.ceil(z),n}function wt(o,t,e,i){let r=e?.fontSize?e.fontSize:W,s=Math.ceil(r*(B.lineHeight-1)/2),n=e?.verticalAlign??1,{left:h,top:l,height:a}=t,c=Math.max(t.width,...o.map(p=>p.width)),d=[],f=0,u=0;if(e?.isWrapText&&i){let p=0;for(let w=0;w<o.length;w++){let C=o[w];f=Math.max(f,C.width);let x=C.height+s*2;u+=x,d.push({text:C.str,x:0,y:p,width:C.width,height:C.height}),p+=x}}else if(e?.isWrapText){let p=0;for(let w=0;w<o.length;){let C=c,x="",z=0,I=0;for(;w<o.length;){let b=o[w];if(C>=b.width)z+=b.width,I=Math.max(I,b.height),C-=b.width,x+=b.str,w++;else break}if(x){f=Math.max(f,z);let b=I+s*2;u+=b,d.push({text:x,x:0,y:p,width:z,height:I}),p+=b}}}else{let p="",w=c;for(let C=0;C<o.length;C++){let x=o[C];if(w>=x.width)f+=x.width,u=Math.max(u,x.height),p+=x.str,w-=x.width;else break}d.push({text:p,x:0,y:0,width:f,height:u})}if(u=Math.max(u,r*B.lineHeight),f+=s,u+=s,f<=c&&u<=a){let p=h+s,w=l+(a-u)/2+s;n===0?w=l+s:n===2&&(w=l+(a-u)+s),e?.horizontalAlign===1?p=h+(c-f)/2:e?.horizontalAlign===2&&(p=h+(c-f)-s);for(let C of d)C.x=C.x+p,C.y=C.y+w}return{width:f,height:u,resultList:d}}function $(o){return{textAlign:"center",textBaseline:"middle",font:O(void 0,"500",g(W)),fillStyle:v("black",o),lineWidth:m,strokeStyle:v("borderColor",o)}}var ut=Math.max(...Object.values(L)),E=class{constructor(t){this.width=0;this.height=0;this.isRendering=!1;this.rowMap={};this.colMap={};this.eventData={theme:"light",sheetData:{},canvasSize:{top:0,left:0,width:0,height:0},headerSize:{width:0,height:0},currentSheetInfo:{isHide:!1,rowCount:0,colCount:0,name:"",sheetId:"",tabColor:"",sort:1},scroll:{left:0,top:0,row:0,col:0,scrollLeft:0,scrollTop:0},range:{row:0,col:0,rowCount:1,colCount:1,sheetId:""},copyRange:void 0,customHeight:{},customWidth:{},currentMergeCells:[]};this.canvas=t,this.ctx=t.getContext("2d");let e=P();this.ctx.scale(e,e)}render(t){if(t.changeSet.size===0||this.isRendering)return;this.isRendering=!0,this.eventData=t,this.clear();let{ctx:e}=this;e.strokeStyle=v("primaryColor",t.theme),e.fillStyle=v("white",t.theme),e.lineWidth=m*2;let{width:i,height:r}=this.eventData.canvasSize,s=this.eventData.headerSize,{endRow:n,contentHeight:h}=this.renderRowsHeader(r),{endCol:l,contentWidth:a}=this.renderColsHeader(i);this.renderGrid(i-s.width,r-s.height),this.renderTriangle(),this.renderMergeCell(),this.ctx.fillStyle=v("selectionColor",this.eventData.theme);let c=this.renderSelection({endRow:n,endCol:l,contentHeight:h,contentWidth:a});return this.renderAntLine(c),this.renderContent({endRow:n,endCol:l,contentHeight:h,contentWidth:a}),this.ctx.lineWidth=ut,X(this.ctx,c.left,c.top,c.width,c.height),this.isRendering=!1,{rowMap:this.rowMap,colMap:this.colMap}}resize(t){this.width=t.width,this.height=t.height,this.canvas.width=g(t.width),this.canvas.height=g(t.height)}clear(){Z(this.ctx,0,0,this.width,this.height)}renderRowsHeader(t){let{row:e}=this.eventData.scroll,i=this.eventData.headerSize,{rowCount:r}=this.eventData.currentSheetInfo;this.ctx.save();let s=this.eventData.range;R(this.ctx,0,i.height,i.width,t),Object.assign(this.ctx,$(this.eventData.theme));let n=[],h=i.height,l=e;for(;l<r&&h<t;l++){let c=this.getRowHeight(l),d=h;if(l===e&&(d+=m/2),n.push([0,d],[i.width,d]),c>0){let f=this.isHighlightRow(s,l);this.ctx.fillStyle=f?v("primaryColor",this.eventData.theme):v("black",this.eventData.theme),F(this.ctx,String(l+1),i.width/2,d+c/2)}h+=c}n.push([0,h],[i.width,h]),n.push([0,0],[0,h]),T(this.ctx,n),this.ctx.restore();let a=l>=r?h:t;return{endRow:l,contentHeight:Math.floor(a)}}renderColsHeader(t){let{col:e}=this.eventData.scroll,i=this.eventData.headerSize,{colCount:r}=this.eventData.currentSheetInfo,s=this.eventData.range,n=[];this.ctx.save(),R(this.ctx,i.width,0,t,i.height),Object.assign(this.ctx,$());let h=i.width,l=e;for(;l<r&&h<=t;l++){let c=this.getColWidth(l),d=h;if(l===e&&(d+=m/2),n.push([d,0],[d,i.height]),c>0){let f=this.isHighlightCol(s,l);this.ctx.fillStyle=f?v("primaryColor",this.eventData.theme):v("black",this.eventData.theme),F(this.ctx,rt(l),d+c/2,i.height/2)}h+=c}n.push([h,0],[h,i.height]),n.push([0,0],[h,0]),T(this.ctx,n),this.ctx.restore();let a=l>=r?h:t;return{endCol:l,contentWidth:Math.floor(a)}}renderGrid(t,e){let i=this.eventData.headerSize,{row:r,col:s}=this.eventData.scroll,{rowCount:n,colCount:h}=this.eventData.currentSheetInfo;this.ctx.save(),this.ctx.lineWidth=m,this.ctx.strokeStyle=v("borderColor",this.eventData.theme),this.ctx.translate(g(i.width),g(i.height));let l=[],a=0,c=0;for(let d=r;d<n&&a<=e;d++){for(;d<n&&this.getRowHeight(d)===0;)d++;l.push([0,a],[t,a]);let f=this.getRowHeight(d);a+=f}for(let d=s;d<h&&c<=t;d++){for(;d<h&&this.getColWidth(d)===0;)d++;l.push([c,0],[c,a]);let f=this.getColWidth(d);c+=f}l.push([0,a],[c,a]),l.push([c,0],[c,a]),T(this.ctx,l),this.ctx.restore()}renderTriangle(){let t=this.eventData.headerSize;this.ctx.save(),R(this.ctx,0,0,t.width,t.height),this.ctx.fillStyle=v("triangleFillColor",this.eventData.theme);let e=2,i=Math.floor(e),r=Math.floor(t.height-e),s=Math.floor(t.width*.4),n=Math.floor(t.width-e);ct(this.ctx,[n,i],[s,r],[n,r]),this.ctx.restore()}getRowHeight(t){let e=j(this.eventData.currentSheetInfo.sheetId,t),i=this.eventData.customHeight[e];return i?i.isHide?U:i.len:G}getColWidth(t){let e=j(this.eventData.currentSheetInfo.sheetId,t),i=this.eventData.customWidth[e];return i?i.isHide?U:i.len:N}isHighlightRow(t,e){return!!(H(t)||_(t)||e>=t.row&&e<t.row+t.rowCount)}isHighlightCol(t,e){return!!(H(t)||k(t)||e>=t.col&&e<t.col+t.colCount)}renderAntLine(t){let e=this.eventData.copyRange;!e||e.sheetId!==this.eventData.currentSheetInfo.sheetId||(this.ctx.lineWidth=ut,this.ctx.strokeStyle=v("primaryColor",this.eventData.theme),ft(this.ctx,t.left,t.top,t.width,t.height))}renderMergeCell(){let t=this.eventData.currentMergeCells;if(t.length===0)return;let e=this.eventData.range;for(let i of t)e.row===i.row&&e.col===i.col||this.clearRect(i)}getCellSize(t){let{row:e,col:i,colCount:r,rowCount:s}=t,n=e,h=i,l=e+s,a=i+r,c=this.eventData.currentSheetInfo;H(t)?(h=0,a=c.colCount,n=0,l=c.rowCount):_(t)?(n=0,l=c.rowCount):k(t)&&(h=0,a=c.colCount);let d=0,f=0;for(;n<l;n++)f+=this.getRowHeight(n);for(;h<a;h++)d+=this.getColWidth(h);return{width:d,height:f}}computeCellPosition(t){let{row:e,col:i}=t,r=this.eventData.headerSize,s=this.eventData.scroll,n=r.width,h=r.height,l=s.row,a=s.col;if(i>=s.col)for(;a<i;)n+=this.getColWidth(a),a++;else for(n=-r.width;a>i;)n-=this.getColWidth(a),a--;if(e>=s.row)for(;l<e;)h+=this.getRowHeight(l),l++;else for(h=-r.height;l>e;)h-=this.getRowHeight(l),l--;return{top:h,left:n}}getActiveRange(t){let e=t||this.eventData.range,i=this.eventData.currentMergeCells;for(let r of i)if(st(e,r))return{range:{...r,sheetId:r.sheetId},isMerged:!0};return{range:e,isMerged:!1}}clearRect(t){let e=this.getCellSize(t);if(e.width<=0||e.height<=0)return;let i=this.computeCellPosition(t),r=m;Z(this.ctx,i.left+r,i.top+r,e.width-r*2,e.height-r*2)}renderContent(t){let{endCol:e,endRow:i,contentHeight:r,contentWidth:s}=t,{ctx:n}=this;n.textAlign="left",n.textBaseline="top",n.lineWidth=m*2;let h=this.eventData.headerSize,{row:l,col:a}=this.eventData.scroll,c=Math.floor(s-h.width),d=Math.floor(r-h.height);n.save(),this.rowMap={},this.colMap={};let f=this.eventData.currentMergeCells;for(let u=l;u<i;u++)for(let p=a;p<e;p++){let w=f.find(C=>C.row===u&&C.col===p);this.renderCell(u,p,w,c,d)}n.restore()}renderCell(t,e,i,r,s){let{ctx:n}=this,h={row:t,col:e,rowCount:1,colCount:1,sheetId:""},l=it(t,e),a=this.eventData.sheetData[l];if(!a)return;let c=this.getCellSize(i||h);if(c.width<=0||c.height<=0)return;let d=this.computeCellPosition(h);n.lineWidth=m*2;let f=this.eventData.theme,u=gt(n,{top:d.top,left:d.left,width:Math.min(c.width,r),height:Math.min(c.height,s)},a.value,a.style,!!i,f),p=Math.max(this.rowMap[t]??0,u.height),w=Math.max(this.colMap[e]??0,u.width);p>=G&&(this.rowMap[t]=p),w>=N&&(this.colMap[e]=w);let C={top:d.top,left:d.left,height:Math.max(p,c.height),width:Math.max(w,c.width)};A(n,C,a.style?.borderTop,"top",f),A(n,C,a.style?.borderBottom,"bottom",f),A(n,C,a.style?.borderLeft,"left",f),A(n,C,a.style?.borderRight,"right",f)}renderSelection(t){let e=this.eventData.range;return H(e)?this.renderSelectAll(t):_(e)?this.renderSelectCol(t):k(e)?this.renderSelectRow(t):this.renderSelectRange()}renderSelectRange(){let t=this.eventData.headerSize,e=this.eventData.range,i=this.computeCellPosition({row:e.row,col:e.col,rowCount:1,colCount:1,sheetId:""}),r=e.row+e.rowCount-1,s=e.col+e.colCount-1,n={row:r,col:s,rowCount:1,colCount:1,sheetId:""},h=this.computeCellPosition(n),l=this.getCellSize(n),a=h.left+l.width-i.left,c=h.top+l.height-i.top;R(this.ctx,i.left,0,a,t.height),R(this.ctx,0,i.top,t.width,c);let d=e.rowCount>1||e.colCount>1;d&&R(this.ctx,i.left,i.top,a,c);let f=[[i.left,t.height],[i.left+a,t.height]];return f.push([t.width,i.top],[t.width,i.top+c]),T(this.ctx,f),d&&this.renderActiveCell(),{left:i.left,top:i.top,width:a,height:c}}renderSelectAll(t){let{contentHeight:e,contentWidth:i}=t,r=this.eventData.headerSize;R(this.ctx,0,0,i,e),this.renderActiveCell();let s=i-r.width,n=e-r.height;return{left:r.width,top:r.height,width:s,height:n}}renderSelectCol({contentHeight:t}){let e=this.eventData.headerSize,i=this.eventData.range,r=this.computeCellPosition(i),s=0;for(let l=i.col,a=i.col+i.colCount;l<a;l++)s+=this.getColWidth(l);let n=t-e.height;R(this.ctx,r.left,0,s,t),R(this.ctx,0,r.top,e.width,n);let h=[[e.width,e.height],[e.width,t]];return T(this.ctx,h),this.renderActiveCell(),{left:r.left,top:e.height,width:s,height:n}}renderSelectRow({contentWidth:t}){let e=this.eventData.headerSize,i=this.eventData.range,r=this.computeCellPosition(i),s=0;for(let l=i.row,a=i.row+i.rowCount;l<a;l++)s+=this.getRowHeight(l);let n=t-e.width-m;R(this.ctx,r.left,0,n,e.height),R(this.ctx,0,r.top,t,s);let h=[[r.left,e.height],[t,e.height]];return T(this.ctx,h),this.renderActiveCell(),{left:e.width,top:r.top,width:n,height:s}}renderActiveCell(){let t=this.eventData.range,e=this.getActiveRange({row:t.row,col:t.col,rowCount:1,colCount:1,sheetId:t.sheetId}).range;this.clearRect(e)}};var J=null,vt={init(o){J=new E(o.canvas),ot(o.dpr)},resize(o){J?.resize(o)},async render(o,t){let e=J?.render(o);e&&await t(e)},computeFormulas:at},re=vt;export{re as a};
//# sourceMappingURL=chunk-3N5BLAQY.js.map
